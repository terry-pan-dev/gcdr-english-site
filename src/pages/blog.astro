---
import '../styles/globals.css';
import { getCollection } from 'astro:content';
import { Navigation } from '../components/Navigation';
import { Footer } from '../components/Footer';
import { BlogCard } from '../components/BlogCard';
import { BlogSidebar } from '../components/BlogSidebar';
import { TimelineConnector } from '../components/TimelineConnector';
import { getGoogleFontsUrl, getPrimaryFontFamily, getSecondaryFontFamily } from '../config/fonts';

const posts = await getCollection('posts');

// Filter posts: only show published posts with current or past dates
const now = new Date();
const publishedPosts = posts.filter((post) => {
  // Check if post is published
  const isPublished = post.data.publish ?? true;
  if (!isPublished) return false;
  
  // Check if post date is today or in the past
  const postDate = new Date(post.data.date);
  postDate.setHours(0, 0, 0, 0); // Reset to start of day for comparison
  const today = new Date(now);
  today.setHours(0, 0, 0, 0);
  
  return postDate <= today;
});

const sortedPosts = publishedPosts.sort((a, b) => {
  // First, sort by pinned status (pinned posts first)
  const aPinned = a.data.pinned ?? false;
  const bPinned = b.data.pinned ?? false;
  if (aPinned !== bPinned) {
    return bPinned ? 1 : -1; // Pinned posts come first
  }
  // Then sort by date (newest first)
  return new Date(b.data.date).getTime() - new Date(a.data.date).getTime();
});

// Get category filter from URL
const categoryFilter = Astro.url.searchParams.get('category') || null;
const filteredPosts = categoryFilter
  ? sortedPosts.filter((post) => post.data.category === categoryFilter)
  : sortedPosts;

// Pagination setup
const postsPerPage = 10;
const currentPage = Math.max(1, parseInt(Astro.url.searchParams.get('page') || '1', 10));
const totalPosts = filteredPosts.length;
const totalPages = Math.ceil(totalPosts / postsPerPage);
const startIndex = (currentPage - 1) * postsPerPage;
const endIndex = startIndex + postsPerPage;
const paginatedPosts = filteredPosts.slice(startIndex, endIndex);

const categories = [...new Set(publishedPosts.map((p) => p.data.category))];

// Helper function to build pagination URL
function getPageUrl(page: number, category: string | null) {
  const params = new URLSearchParams();
  if (category) params.set('category', category);
  if (page > 1) params.set('page', page.toString());
  const queryString = params.toString();
  return `/blog${queryString ? `?${queryString}` : ''}`;
}

// Generate page numbers array for pagination UI
const pageNumbers: Array<{ page: number; isEllipsis: boolean }> = [];
let lastAdded = 0;

for (let i = 1; i <= totalPages; i++) {
  const showPage =
    i === 1 ||
    i === totalPages ||
    (i >= currentPage - 1 && i <= currentPage + 1);
  
  if (showPage) {
    // Add ellipsis if there's a gap
    if (i - lastAdded > 1) {
      pageNumbers.push({ page: 0, isEllipsis: true });
    }
    pageNumbers.push({ page: i, isEllipsis: false });
    lastAdded = i;
  }
}

const googleFontsUrl = getGoogleFontsUrl();
const primaryFont = getPrimaryFontFamily();
const secondaryFont = getSecondaryFontFamily();
---

<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Dharma Insights - Gold Coast Dharma Realm</title>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href={googleFontsUrl}
      rel="stylesheet"
    />
  </head>
  <body>
    <div class="min-h-screen" style="background-color: #EBE9CF;">
      <Navigation client:load />

      <!-- Hero Section -->
      <div class="relative pt-32 pb-16" style="background-color: #1c1917;">
        <!-- Dot Pattern Background -->
        <div class="absolute inset-0 opacity-10">
          <div
            class="absolute inset-0"
            style="background-image: radial-gradient(circle, #c9a050 1px, transparent 1px); background-size: 50px 50px;"
          >
          </div>
        </div>

        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 relative text-center">
          <!-- Decorative Divider -->
          <div class="inline-flex items-center justify-center mb-6">
            <div class="h-px w-16" style="background-color: #c9a050;"></div>
            <div
              class="mx-4 w-16 h-16 rounded-full flex items-center justify-center"
              style="background-color: #c9a050;"
            >
              <svg
                class="w-8 h-8 text-white"
                fill="none"
                stroke="currentColor"
                viewBox="0 0 24 24"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="1.5"
                  d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253"
                ></path>
              </svg>
            </div>
            <div class="h-px w-16" style="background-color: #c9a050;"></div>
          </div>

          <h1
            class="text-5xl md:text-6xl mb-6 font-serif"
            style={`color: #EBE9CF; font-family: ${secondaryFont};`}
          >
            Dharma Insights
          </h1>
          <p
            class="text-xl max-w-3xl mx-auto"
            style={`color: #EBE9CF; opacity: 0.8; font-family: ${primaryFont};`}
          >
            Reflections on practice, teachings, and the path to awakening
          </p>
        </div>
      </div>

      <!-- Main Content -->
      <div class="pt-16 pb-8 sm:pb-12">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
          <div class="flex flex-col lg:flex-row gap-8">
            <!-- Blog List - 2/3 width on desktop -->
            <div class="w-full lg:w-2/3 space-y-4 sm:space-y-8">
              <!-- Mobile Categories - Only visible on phones (hidden on sm: and above) -->
              <div class="block sm:hidden mb-6 -mt-8">
                <div class="flex gap-2 overflow-x-auto pb-2 scrollbar-hide">
                  <a
                    href="/blog"
                    class={`px-4 py-2 rounded-full whitespace-nowrap text-sm font-medium transition-all hover:scale-105 active:scale-95 ${
                      !categoryFilter ? 'font-semibold' : ''
                    }`}
                    style={
                      !categoryFilter
                        ? 'background-color: #c9a050; color: #1c1917;'
                        : 'background-color: white; border: 2px solid #c9a050; color: #1c1917;'
                    }
                  >
                    All
                  </a>
                  {categories.map((category) => (
                    <a
                      href={`/blog?category=${encodeURIComponent(category)}`}
                      class={`px-4 py-2 rounded-full whitespace-nowrap text-sm font-medium transition-all hover:scale-105 active:scale-95 ${
                        categoryFilter === category ? 'font-semibold' : ''
                      }`}
                      style={
                        categoryFilter === category
                          ? 'background-color: #c9a050; color: #1c1917;'
                          : 'background-color: white; border: 2px solid #c9a050; color: #1c1917;'
                      }
                    >
                      {category}
                    </a>
                  ))}
                </div>
              </div>

              {
                paginatedPosts.length > 0 ? (
                  paginatedPosts.map((post, index) => (
                    <>
                      <BlogCard post={post} index={startIndex + index} client:visible />
                      {/* Timeline Connector */}
                      {index < paginatedPosts.length - 1 && (
                        <TimelineConnector index={startIndex + index} client:visible />
                      )}
                    </>
                  ))
                ) : (
                  <div class="text-center py-12">
                    <p class="text-stone-600 text-lg">No posts found.</p>
                  </div>
                )
              }

              {/* Pagination Controls */}
              {totalPages > 1 && (
                <div class="flex flex-col items-center gap-3 mt-20 sm:mt-24 -mb-8 sm:-mb-6">
                  <div class="flex items-center gap-2">
                    {/* Previous Button */}
                    {currentPage > 1 ? (
                      <a
                        href={getPageUrl(currentPage - 1, categoryFilter)}
                        class="px-4 py-2 rounded-lg transition-all hover:scale-105 active:scale-95"
                        style="background-color: white; border: 2px solid #c9a050; color: #1c1917;"
                      >
                        <span class="flex items-center gap-1">
                          <svg
                            class="w-4 h-4"
                            fill="none"
                            stroke="currentColor"
                            viewBox="0 0 24 24"
                          >
                            <path
                              stroke-linecap="round"
                              stroke-linejoin="round"
                              stroke-width="2"
                              d="M15 19l-7-7 7-7"
                            />
                          </svg>
                          Previous
                        </span>
                      </a>
                    ) : (
                      <span
                        class="px-4 py-2 rounded-lg opacity-50 cursor-not-allowed"
                        style="background-color: white; border: 2px solid #c9a050; color: #1c1917;"
                      >
                        <span class="flex items-center gap-1">
                          <svg
                            class="w-4 h-4"
                            fill="none"
                            stroke="currentColor"
                            viewBox="0 0 24 24"
                          >
                            <path
                              stroke-linecap="round"
                              stroke-linejoin="round"
                              stroke-width="2"
                              d="M15 19l-7-7 7-7"
                            />
                          </svg>
                          Previous
                        </span>
                      </span>
                    )}

                    <!-- Page Numbers -->
                    <div class="flex items-center gap-1">
                      {pageNumbers.map((item) => {
                        if (item.isEllipsis) {
                          return (
                            <span class="px-2 text-stone-500">
                              ...
                            </span>
                          );
                        }
                        const page = item.page;
                        return (
                          <a
                            href={getPageUrl(page, categoryFilter)}
                            class={`px-3 py-2 rounded-lg transition-all min-w-[2.5rem] text-center ${
                              page === currentPage
                                ? 'font-semibold'
                                : 'hover:scale-105 active:scale-95'
                            }`}
                            style={
                              page === currentPage
                                ? 'background-color: #c9a050; color: #1c1917;'
                                : 'background-color: white; border: 2px solid #c9a050; color: #1c1917;'
                            }
                          >
                            {page}
                          </a>
                        );
                      })}
                    </div>

                    {/* Next Button */}
                    {currentPage < totalPages ? (
                      <a
                        href={getPageUrl(currentPage + 1, categoryFilter)}
                        class="px-4 py-2 rounded-lg transition-all hover:scale-105 active:scale-95"
                        style="background-color: white; border: 2px solid #c9a050; color: #1c1917;"
                      >
                        <span class="flex items-center gap-1">
                          Next
                          <svg
                            class="w-4 h-4"
                            fill="none"
                            stroke="currentColor"
                            viewBox="0 0 24 24"
                          >
                            <path
                              stroke-linecap="round"
                              stroke-linejoin="round"
                              stroke-width="2"
                              d="M9 5l7 7-7 7"
                            />
                          </svg>
                        </span>
                      </a>
                    ) : (
                      <span
                        class="px-4 py-2 rounded-lg opacity-50 cursor-not-allowed"
                        style="background-color: white; border: 2px solid #c9a050; color: #1c1917;"
                      >
                        <span class="flex items-center gap-1">
                          Next
                          <svg
                            class="w-4 h-4"
                            fill="none"
                            stroke="currentColor"
                            viewBox="0 0 24 24"
                          >
                            <path
                              stroke-linecap="round"
                              stroke-linejoin="round"
                              stroke-width="2"
                              d="M9 5l7 7-7 7"
                            />
                          </svg>
                        </span>
                      </span>
                    )}
                  </div>
                  
                  {/* Page Info */}
                  <p class="text-sm text-stone-600">
                    Showing {startIndex + 1}-{Math.min(endIndex, totalPosts)} of {totalPosts} posts
                    {categoryFilter && ` in "${categoryFilter}"`}
                  </p>
                </div>
              )}
            </div>

            <!-- Sidebar - 1/3 width on desktop -->
            <div class="hidden lg:block w-1/3">
              <BlogSidebar
                categories={categories}
                recentPosts={sortedPosts.slice(0, 5)}
                currentCategory={categoryFilter}
                client:visible
              />
            </div>
          </div>
        </div>
      </div>

      <Footer />
    </div>
  </body>
</html>

<style>
  .scrollbar-hide {
    -ms-overflow-style: none;  /* IE and Edge */
    scrollbar-width: none;  /* Firefox */
  }
  .scrollbar-hide::-webkit-scrollbar {
    display: none;  /* Chrome, Safari and Opera */
  }
</style>
